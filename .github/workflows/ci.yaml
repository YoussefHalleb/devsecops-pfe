name: DevSecOps Pipeline (Sonar + Trivy + ZAP â†’ DefectDojo)

on:
  push:
    branches: ["master"]
  pull_request:

jobs:
  security:
    runs-on: self-hosted

    steps:
    # =====================
    # CHECKOUT
    # =====================
    - name: Checkout code
      uses: actions/checkout@v4

    # =====================
    # BUILD IMAGE
    # =====================
    - name: Build Juice Shop image
      run: docker build -t my-juice-shop .

    # =====================
    # SONARQUBE (SAST)
    # =====================
    - name: SonarQube Scan
      run: |
        docker run --rm \
          -e SONAR_HOST_URL=${{ secrets.SONAR_HOST_URL }} \
          -e SONAR_LOGIN=${{ secrets.SONAR_TOKEN }} \
          -v $(pwd):/usr/src \
          sonarsource/sonar-scanner-cli \
          -Dsonar.projectKey=juice-shop \
          -Dsonar.sources=.

    # =====================
    # TRIVY (SCA)
    # =====================
    - name: Trivy Image Scan
      run: |
        trivy image my-juice-shop \
          --format json \
          --output trivy.json || true

    # =====================
    # RUN APP
    # =====================
    - name: Run Juice Shop
      run: |
        docker network create zap-net || true
        docker run -d --rm \
          --name juice-shop \
          --network zap-net \
          -p 3000:3000 \
          my-juice-shop

    - name: Wait app
      run: sleep 40

    # =====================
    # ZAP (DAST)
    # =====================
    - name: OWASP ZAP Scan
      run: |
        docker run --rm \
          --network zap-net \
          -v $(pwd):/zap/wrk \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-full-scan.py \
          -t http://juice-shop:3000 \
          -x zap.xml || true

    # =====================
    # DEFECTDOJO IMPORTS
    # =====================
    - name: Upload Trivy to DefectDojo
      run: |
        curl -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/" \
          -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
          -F "scan_type=Trivy Scan" \
          -F "file=@trivy.json" \
          -F "engagement=${{ secrets.DD_ENGAGEMENT }}" \
          -F "product=${{ secrets.DD_PRODUCT }}" \
          -F "active=true" \
          -F "verified=false"

    - name: Upload ZAP to DefectDojo
      run: |
        curl -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/" \
          -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
          -F "scan_type=ZAP Scan" \
          -F "file=@zap.xml" \
          -F "engagement=${{ secrets.DD_ENGAGEMENT }}" \
          -F "product=${{ secrets.DD_PRODUCT }}" \
          -F "active=true" \
          -F "verified=false"

    - name: Upload SonarQube to DefectDojo
      run: |
        curl -X POST "${{ secrets.DEFECTDOJO_URL }}/api/v2/import-scan/" \
          -H "Authorization: Token ${{ secrets.DEFECTDOJO_TOKEN }}" \
          -F "scan_type=SonarQube Scan" \
          -F "sonar_project_key=juice-shop" \
          -F "engagement=${{ secrets.DD_ENGAGEMENT }}" \
          -F "product=${{ secrets.DD_PRODUCT }}"
